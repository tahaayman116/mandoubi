<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© - Appwrite</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .cleanup-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #c82333; }
        button.safe { background: #28a745; }
        button.safe:hover { background: #218838; }
        #results { margin-top: 20px; }
        .log { margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 3px; }
        .collection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .count { font-size: 24px; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Appwrite</h1>
        
        <div class="cleanup-section warning">
            <h3>âš ï¸ ØªØ­Ø°ÙŠØ± Ù…Ù‡Ù…:</h3>
            <p>Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Appwrite. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙƒ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©!</p>
        </div>

        <div class="cleanup-section info">
            <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
            <div class="collection-stats" id="stats">
                <div class="stat-card">
                    <div>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</div>
                    <div class="count" id="reps-count">-</div>
                </div>
                <div class="stat-card">
                    <div>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
                    <div class="count" id="subs-count">-</div>
                </div>
                <div class="stat-card">
                    <div>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
                    <div class="count" id="settings-count">-</div>
                </div>
                <div class="stat-card">
                    <div>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</div>
                    <div class="count" id="form-count">-</div>
                </div>
            </div>
        </div>

        <div class="cleanup-section">
            <button class="safe" onclick="loadStats()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button onclick="findDuplicates()">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª</button>
            <button onclick="cleanupDuplicates()">ğŸ§¹ Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1';
        const APPWRITE_PROJECT_ID = '68bcdd830036700d6d5b';
        const APPWRITE_DATABASE_ID = 'mandoub-db';
        const APPWRITE_API_KEY = '1e073f48d9cf466b68a2d3b633d38f4933ec5592b755c15ad1d93d3528c87df243b2693501cca12175863de5e8dae054e4b617dd52651d3c7b46b430a9935bb84ffb017cc1ec03e31943d71dfebf194c4892d299831351df149bed248921bb88ef7445d5115b626cb6cf603d4d3c02aad2097807cee6b7a5d9e017c387c7873a';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function loadStats() {
            log('ğŸ“Š ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª...', 'info');
            
            const collections = [
                { id: 'representatives', element: 'reps-count' },
                { id: 'submissions', element: 'subs-count' },
                { id: 'settings', element: 'settings-count' },
                { id: 'formSettings', element: 'form-count' }
            ];

            for (const collection of collections) {
                try {
                    const response = await fetch(`${APPWRITE_ENDPOINT}/databases/${APPWRITE_DATABASE_ID}/collections/${collection.id}/documents`, {
                        method: 'GET',
                        headers: {
                            'X-Appwrite-Project': APPWRITE_PROJECT_ID,
                            'X-Appwrite-Key': APPWRITE_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById(collection.element).textContent = data.documents.length;
                        log(`âœ… ${collection.id}: ${data.documents.length} Ø¹Ù†ØµØ±`, 'success');
                    } else {
                        document.getElementById(collection.element).textContent = 'Ø®Ø·Ø£';
                        log(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ${collection.id}`, 'error');
                    }
                } catch (error) {
                    document.getElementById(collection.element).textContent = 'Ø®Ø·Ø£';
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ ${collection.id}: ${error.message}`, 'error');
                }
            }
        }

        async function findDuplicates() {
            log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...', 'info');
            
            const collections = ['representatives', 'submissions', 'settings', 'formSettings'];
            let totalDuplicates = 0;

            for (const collectionId of collections) {
                try {
                    const response = await fetch(`${APPWRITE_ENDPOINT}/databases/${APPWRITE_DATABASE_ID}/collections/${collectionId}/documents`, {
                        method: 'GET',
                        headers: {
                            'X-Appwrite-Project': APPWRITE_PROJECT_ID,
                            'X-Appwrite-Key': APPWRITE_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const documents = data.documents;
                    
                    // Find duplicates
                    const duplicates = [];
                    const seen = new Map();
                    
                    documents.forEach(doc => {
                        let key;
                        if (collectionId === 'representatives') {
                            key = `${doc.name}-${doc.role}`;
                        } else if (collectionId === 'submissions') {
                            key = `${doc.villageName}-${doc.representativeName}-${doc.totalPeople}`;
                        } else {
                            key = doc.username || doc.adminPassword || 'settings';
                        }
                        
                        if (seen.has(key)) {
                            duplicates.push(doc);
                        } else {
                            seen.set(key, doc);
                        }
                    });

                    if (duplicates.length > 0) {
                        log(`ğŸ” ${collectionId}: ÙˆØ¬Ø¯ ${duplicates.length} Ø¹Ù†ØµØ± Ù…ÙƒØ±Ø± Ù…Ù† Ø£ØµÙ„ ${documents.length}`, 'warning');
                        totalDuplicates += duplicates.length;
                    } else {
                        log(`âœ… ${collectionId}: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ±Ø±Ø§Øª (${documents.length} Ø¹Ù†ØµØ±)`, 'success');
                    }

                } catch (error) {
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ${collectionId}: ${error.message}`, 'error');
                }
            }

            if (totalDuplicates > 0) {
                log(`âš ï¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©: ${totalDuplicates} Ø¹Ù†ØµØ±`, 'warning');
            } else {
                log('ğŸ‰ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙƒØ±Ø±Ø©!', 'success');
            }
        }

        async function cleanupDuplicates() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
                return;
            }

            log('ğŸ§¹ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©...', 'info');
            
            const collections = ['representatives', 'submissions', 'settings', 'formSettings'];
            let totalDeleted = 0;

            for (const collectionId of collections) {
                try {
                    log(`ğŸ“‹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¬Ù…ÙˆØ¹Ø©: ${collectionId}`, 'info');
                    
                    const response = await fetch(`${APPWRITE_ENDPOINT}/databases/${APPWRITE_DATABASE_ID}/collections/${collectionId}/documents`, {
                        method: 'GET',
                        headers: {
                            'X-Appwrite-Project': APPWRITE_PROJECT_ID,
                            'X-Appwrite-Key': APPWRITE_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    const documents = data.documents;
                    
                    // Find duplicates
                    const duplicates = [];
                    const seen = new Map();
                    
                    documents.forEach(doc => {
                        let key;
                        if (collectionId === 'representatives') {
                            key = `${doc.name}-${doc.role}`;
                        } else if (collectionId === 'submissions') {
                            key = `${doc.villageName}-${doc.representativeName}-${doc.totalPeople}`;
                        } else {
                            key = doc.username || doc.adminPassword || 'settings';
                        }
                        
                        if (seen.has(key)) {
                            duplicates.push(doc);
                        } else {
                            seen.set(key, doc);
                        }
                    });

                    if (duplicates.length === 0) {
                        log(`âœ… ${collectionId}: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ±Ø±Ø§Øª`, 'success');
                        continue;
                    }

                    log(`ğŸ—‘ï¸ Ø­Ø°Ù ${duplicates.length} Ø¹Ù†ØµØ± Ù…ÙƒØ±Ø± Ù…Ù† ${collectionId}...`, 'warning');

                    // Delete duplicates
                    let deletedCount = 0;
                    for (const duplicate of duplicates) {
                        try {
                            const deleteResponse = await fetch(`${APPWRITE_ENDPOINT}/databases/${APPWRITE_DATABASE_ID}/collections/${collectionId}/documents/${duplicate.$id}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-Appwrite-Project': APPWRITE_PROJECT_ID,
                                    'X-Appwrite-Key': APPWRITE_API_KEY,
                                    'Content-Type': 'application/json'
                                }
                            });

                            if (deleteResponse.ok) {
                                deletedCount++;
                            }

                            // Add delay to avoid rate limiting
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (error) {
                            log(`âŒ ÙØ´Ù„ Ø­Ø°Ù Ø¹Ù†ØµØ± Ù…Ù† ${collectionId}`, 'error');
                        }
                    }

                    log(`âœ… ${collectionId}: ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…Ù† ${duplicates.length} Ø¹Ù†ØµØ±`, 'success');
                    totalDeleted += deletedCount;

                } catch (error) {
                    log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© ${collectionId}: ${error.message}`, 'error');
                }
            }

            log(`ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙ†Ø¸ÙŠÙ! ØªÙ… Ø­Ø°Ù ${totalDeleted} Ø¹Ù†ØµØ± Ù…ÙƒØ±Ø±`, 'success');
            
            // Refresh stats
            setTimeout(loadStats, 1000);
        }

        // Load initial stats
        loadStats();
    </script>
</body>
</html>
